# 第十三章 web浏览器中的JavaScript

## 概念

合法的JavaScript代码需要运行的环境，需要一个可供运行的上下文环境

## 1、客户端JavaScript

* window对象是所有客户端JavaScript特性和api的主要接入点
  * location属性指定当前显示在窗口的URL，也可以用来跳转新URL
  * alert弹出对话框来显示信息，但注意，这个行为会暂停全部窗口行动
  * setTimeOut是在给定的一段时间后才触发回调
  * document属性非常重要，引用Document对象，getElementById可以基于元素id属性的值返回单一的文档元素，也就是一对标签内的内容（这个返回的对象属于element对象，还有对应的重要的属性和方法，其中典型的就是style），这个元素可以被赋予给声明变量。需要注意，标签class有些时候必须要设置高宽
* onclick和onload方法都是很重要的处理方法
* web文档的JavaScript，可以用JavaScript通过document和element对象对各类样式或是行动进行操作
* web浏览器设置有很多底层api以实现web应用，JavaScript在web应用中的作用大过web文档，JavaScript增强了web文档，但是设计良好的文档需要在脱离JavaScript后还能正常继续工作

## 2、HTML中嵌入JavaScript

* 4种方法：
  * 放置在<script></script>标签之间
  * 放置在<script>标签src属性指定的外部文件
  * 放置在HTML事件处理程序中，由onclick或onmouseover这样的HTML属性指定
  * 就在一个URL里，这个URL使用特殊的“javascript：”协议
  
* 1、<script>元素
  
  * JavaScript的代码以内联的形式出现在HTML的标签<script></script>中，或者通过src导入外部js文件
  
* 2、外部文件中的脚本

  * src指定路径URL导入JavaScript代码的文件

  * <script src="../../scripts/utils.js"></script>

  * 优点：

    * 将大量的JavaScript代码从HTML文件中移出；
    * 可以多个HTML文件共用通用的方法，不用每次都重复书写；
    * 如果一个JavaScript代码文件是多个页面共享的，只需要下载它一次，通过使用它的第一个页面，随后的页面可以从浏览器缓存中检索到
    * src可以读取任何URL，也就是说，从web服务器的JavaScript程序可以使用另一个web服务器输出的代码

* 3、脚本类型

  * VBScript只有IE支持，必须用type属性指定：<script src="test/vbscript"></script>
  * 如果是老的浏览器，会使用language属性代替type属性，现在也可能遇见，但其实不应该再使用：<script language="javascript"></script>

* 4、HTML中的事件处理程序

  * 当脚本所在的HTML文件被载入浏览器时，这个脚本里的JavaScript代码只会执行一次
  * 所以为了保证交互，就会通过事件处理程序将浏览器事先注册的函数调用作为处理程序的响应

* 5、URL中的JavaScript

  * 类似这样：<a href="javascript:new Date().toLocalTimeString();"></a>
  * 还有一种情况是将多行代码放入单引号内，解析时仍然会被视为一行，另外，在这中间，//的标注是无效的，必须用/**/的结构，同时代码不能包含任何单引号

## 3、JavaScript程序的执行

* 概念：
  * 事件驱动阶段里发生的第一个事件是load事件
  * 核心JavaScript和客户端JavaScript都有一个单线程执行模型，脚本和事件处理程序在同一时间只能执行一个，没有并发性
* 1、同步、异步和延迟的脚本
  * JavaScript第一次添加到web浏览器的时候，还没有API可以用来遍历和操作文档的结构和内容
  * 还在载入的时候，唯一能够影响文档内容的是快速生成内容，通过document.write()方法完成
* 2、事件驱动的JavaScript
  * 这类事件处理程序的属性名都是on开始的
  * 谈论事件的时候，必须同时指定事件类型和目标：HTMLButtonElement对象上绑定一个单击事件，或者一个readystatechange事件绑定在XMLHTTPRequest上
* 3、客户端JavaScript线程模型
  * 传统并没有，HTML5有一种后台线程的“WebWorker”，但是客户端JavaScript还是严格的按照单线程一样工作
  * 单线程确保了两个事件处理器不会同时运行，永远不需要当心各类锁的问题，同时这种情况就必须在脚本和事件处理程序执行的时候停止响应用户输入
* 4、客户端JavaScript时间线
  * 1.web浏览器创建Document对象，并且开始解析web页面，解析HTML元素和它们的文本内容后添加element对象和text节点到文档中，这个阶段的document.readystate属性的值是“loading”
  * 2.当HTML解析器遇到没有async和defer属性的<script>元素时，它把这些元素加到文档中，然后执行内或外部脚本，这些脚本会同步执行，并且在脚本下载和执行时解析器会暂停。
  * 3.当遇到了设置了async属性的<script>元素的时候，它开始下载文本，并继续解析文档，脚本会在它下载完成后尽快执行，但是解析器没有停下来等它下载。异步脚本禁用document.write()
  * 4.完成解析，document.readyState转换为“interactive”
  * 5.所有的defer属性的脚本，会按它们在文档里的出现顺序执行，异步脚本可能也在这个时间执行。延迟脚本可以访问完整的文档树，禁止使用document.write()方法
  * 6.浏览器在document对象上触发DOMContentLoaded事件。这标志着程序执行从同步脚本执行阶段转换到了异步事件驱动的阶段。要注意这时还会有异步脚本没有执行完成
  * 7.文档完全解析完成，但是浏览器可能还在等待其他内容载入，当所有这些内容完成载入时，并且所有异步脚本完成载入和执行，document.readyState属性改变为“complete”，web浏览器会触发Windows对象上的load事件
  * 8.此刻起，会调用异步事件，以异步响应用户输入事件、网络事件、计时器过期等

## 4、兼容性和互用性

* 概念：web是存在着各种差异的环境，会面临web文档和应用在不同操作系统的不同时代的浏览器上查看和运行
* 问题可以归为三类：
  * 演化：一些新的特性添加到浏览器中，但一些老的浏览器可能无法使用它
  * 未实现：某一特性，一些浏览器已经开始使用，而另一些浏览器则没有实现甚至是决定不实现某些特性
  * bug：每个浏览器都存在bug，有时候编写能够被所有浏览器兼容的JavaScript程序是非常困难的
* 1、处理兼容性问题的类库
  * 为了解决某些浏览器不兼容一些特性或者元素的情况，会专门对这些情况进行模拟，配套一个脚本文件或者更多文件来配合使用以达到能够实现这些功能的需求。
  * excanvas.js就是非常好的例子
* 2、分级浏览器支持：一种测试技术。对浏览器厂商/版本/操作系统进行分级，A级浏览器要通过所有的功能测试用例，C级不需要所有的用例都通过测试
* 3、功能测试：所谓功能测试，其实就是为了保证能够更加适配各自的浏览器做出的一些确认用分支，比如说if语句判断一下某个功能是否可用
* 4、怪异模式和标准模式
  * 标准模式：严格遵循CSS标准。通过document.compatMode属性来识别，CSS1Compat就是标准模式
  * 怪异模式：如果值是BackCompat或者undefined就是怪异模式，指代非标准模式
* 5、浏览器测试：Navigator对象，检测浏览器类型和版本，确定当前浏览器的厂商和版本的代码，通常叫做浏览器嗅探器
* 6、Internet Explorer里的条件注释：运用注释标注好本段代码属于什么版本的浏览器使用

## 5、可访问性：web页面有时需要考虑各种用户设计可访问性，例如不能操作键盘需要语音操作的残疾人，只能使用键盘的情况等等

## 6、安全性

* 1、JavaScript不能做什么

  * 可以打开新的窗口，但是为了避免恶意广告弹出，很多浏览器都是限制了这个功能的
  * 可以自行关闭当前的窗口，但是不可以不通过用户的确认就关闭
  * HTML FileUpload元素的value属性是只读的
  * 脚本不能读取从不同服务器载入的文档的内容，除非这个就是包含该脚本的文档
  * 不同的浏览器可能会有不同的策略，所以禁止项不一定全都相似

* 2、同源策略：是对JavaScript代码能够操作哪些web内容的一条完整的安全限制，但某些情况下，同源策略就太过严格了，有时会需要用到不严格的同源策略。三种不严格的：1.通过document的domain属性给多个窗口赋予同源性2.跨域资源共享3.跨文档资源共享

* 3、脚本化插件和ActiveX控件：一些插件（flash和java）为客户端提供非常重要且强大的特性，但也存在着缺点，它们具有访问底层网络的能力，尽管现在能够防止其造成的漏洞，但这仍然算是一个安全隐患

* 4、跨站脚本：

  * 叫做XSS，用来表示一类安全问题，也就是攻击者向目标web站点注入HTML标签或者脚本，防止XSS的攻击是服务器端web必要的工作。

  * 通常攻击者通过window.location.search来获得它们自己的URL中以"?"开始的部分，而后通过write（）来对文档添加动态生成的内容，恶意的脚本还会获取被攻击者的cookie，诱骗用户点击发送更多数据

  * 通常想要防止这种攻击，在使用任何不可信的数据来动态的创建文档内容前，从中溢出HTML标签。如下：

    ``` JavaScrip
    name = name.replace(/</g,"&lt;").repalce(/>/g,"&gt;");
    ```

    

* 5、拒绝服务攻击：同源策略和安全限制可以很好的防止。

## 7、客户端框架

* 基于客户端框架或者类库来创建它们的web应用非常便捷，某种意义上类库也是框架。jquery是当前最流行的框架之一。
* prototype类库和jQuery相似，专门针对DOM和Ajax实现的一套实用工具
* Dojo是一个大型的框架，它宣称自己“深不可测”，它包含一个种类繁多的UI组件集合、包管理系统、数据抽象层等
* YUI是Yahoo！使用的一个著名框架，和Dojo一样庞大
* Closure不需要保持特性集合的紧凑，是一个庞大的实用工具集
* GWT用Java定义web应用接口，一般在Google产品中使用，但是不如closure广泛