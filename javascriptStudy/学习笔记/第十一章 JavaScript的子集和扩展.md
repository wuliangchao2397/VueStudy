# 第十一章 JavaScript的子集和扩展

## 概念

* 子集的定义大多数出于安全考虑
* 可以用来写Firefox扩展插件

## 1、JavaScript的子集

* 概念：大多数语言都会选择定义自己的子集，保证更安全的执行不可信的第三方代码
* 1、精华
  * 语言子集的目标是简化这门语言，规避掉语言中怪癖、缺陷部分
  * 大多数语言都有精华部分和鸡肋部分，把握精华部分对程序的效率把控很重要
* 2、子集的安全性
  * 要用到一个大子集，目的是能在一个容器内安全的运行不可信的第三方JavaScript代码，所有会破坏这个容器并影响全局执行环境的语言特性和api在这里都是禁止的
  * 每个子集都有一个静态的检查器
  * 移除了一些JavaScript特性：
    * eval（）和Function（）构造函数是禁止使用的，因为他们可以执行任何代码
    * 禁用this关键字，这个容器的目的之一就是阻止全局对象的访问
    * 禁止使用with，with会影响静态代码检查
    * 禁止使用某些全局变量，例如window对象的引用，两种对document对象的处理。其一，完全禁用document，自定义一组api以对分配给它的Web页面做有限制的访问。其二，在容器内部定义一个只对外提供安全的标准DOM API的外观面板或者document对象
    * 禁用某些属性和方法，arguments的caller和callee、函数的call（）和apply（）方法，constructor和prototype属性
    * 静态分析可以防止带有(.)运算符的属性存取表达式，但方括号不能有效防止，基于这个原因，方括号通常是禁止的
  * ADsafe：第一个正式提出的安全子集
  * Caja：Google发布的开源安全子集
  * FBJS：JavaScript语言的变种，被Facebook采用，用以在用户个人资料潜入不可信的第三方代码

## 2、常量和局部变量

* 概念：
  * 关于语言扩展，在JavaScript1.5以后的版本，可以用const定义常量，也就是不可重复赋值的变量
  * 和var相似，由于没有块级作用域，会被提前到函数定义的顶部
  * 关键字let：
    * JavaScript1.7及以后的版本才能使用
    * 可以作为变量声明，和var一样
    * 在for或for/in循环中，作为var的替代方案
    * 在语句块中定义一个新变量并显式指定它的作用域
    * 定义一个在表达式内部作用域中的变量，这个变量只在表达式内可以用
    * 在声明语句中使用let是在变量作用域内计算初始化，但循环初始化器中使用let就是在作用域外计算
    * 和var相似，在执行到let语句之前，变量就已经存在，但是必须要执行到let才会开始初始化，否则值是undefined

## 3、解构赋值

* 是一种混合式赋值，等号右侧是一个数组或对象，左侧一个或多个变量，语法和右侧一致
* 解构赋值可以用于var和let声明的变量
* 右侧和左侧不一定要一致，左侧多余的变量会被赋予undefined，右侧如果多余就会无视
* 嵌套数组和嵌套对象都可以用于解构赋值

## 4、迭代

* 1、for/each循环
  * 与for/in循环相似，但是遍历的不是属性而是值
  * 不仅仅针对数组的元素进行遍历，它也会遍历数组中所有可枚举属性的值
* 2、迭代器
  * 是一个对象，这个对象允许对它的值集合进行遍历，并保持任何必要的状态以便能够跟踪到当前遍历的位置
  * 必须包含next（）方法，调用next（）会返回集合中的下一个值。对应有限的集合，如果next（）没有多余的值可以迭代时，会抛出StopIteration，是专门为了终结迭代的目的而保留的对象。一般使用try和catch结构接住。
  * JavaScript1.7之后的for/in可以迭代可迭代的值，会自行处理StopIteration且开发者不可见
  * Interator（）传入的对象或者数组如果没有定义迭代方法，会返回一个可迭代的自定义迭代器
* 3、生成器
  * 运用了新关键字yield，必须显示指定JavaScript1.7才能使用，在函数内使用，与return相似，返回函数中的一个值。不同的地方在于，yield产生一个可保持函数内部状态的值，这个值是可以恢复的
  * 使用yield的都是生成器函数，可以用return来终止函数，但不能返回值
  * 生成器函数中yield的返回值就是next（）的返回值
  * 调用close（），相关的生成器都会终止执行，一般将它放在finally语句中
  * send（）函数可以用来重启生成器的执行，可以带一个参数
  * throw（）也可以重启生成器
* 4、数组推导
  * 利用另外一个数组或可迭代对象来初始化数组元素
  * 三个部分：
    * 没有循环体的for/in或for/each循环
    * 执行遍历对象后的if条件表达式，用于过滤迭代的值
    * for之前是expression，可以把这个表达式当成循环体，迭代器返回了一个值并赋给它一个变量，这个变量通过了conditional条件之后，将计算这个表达式，并把计算结果放入要创建的数组中
* 5、生成器表达
  * 将数组推导中的方括号换成圆括号，就成了一个生成器表达式，和推导非常相似，但返回的是生成器对象而不是数组

## 5、函数简写

* 表达式闭包
* 如果函数只计算一个表达式并返回它的值，关键字return和花括号都可以省略

## 6、多catch语句 

* 多catch语句，不是就想if-else if的关系一样，非最后一个catch，参数需要if条件判断表达式

## 7、E4X:ECMAScript for XML

* 一种标准扩展，将XML文档视为XML对象，将XML片段视为XML列表对象，typeof运算结果是“xml”
* 直接量语法使用花括号作为质安义字符，可以在XML中嵌入JavaScript表达式
* XML（）可以将字符串解析成XML
* 访问创建XML内容的语法：
  * （..）代替（.）作为访问运算符
  * @用来区分属性名和标签名
  * @*用于获得属性名
  * for/each可以遍历XML标签和列表
  * EX4表达式可以出现在赋值的左侧
  * 完全支持命名空间

